<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <link href="/node_modules/tabulator-tables/dist/css/tabulator_simple.min.css" rel="stylesheet">
    <title>고객목록</title>
    <style>
        h1 {
            text-align: center;
        }
        .buttons {
            margin-bottom: 15px;
            text-align: right;
        }
        .buttons button {
            padding: 3px 15px;
        }
        .tabulator {
            border: 1px solid #999;
        }
        .tabulator-row .tabulator-cell:last-of-type {
            border-right: 1px solid #ddd;
        }
    </style>
</head>
<body>
<h1>고객목록</h1>
<div class="buttons">
    <button id="searchBtn">조회</button>
    <button id="addRowBtn">추가</button>
    <button id="saveBtn">저장</button>
</div>
<!-- 고객목록 그리드 -->
<div id="client-grid" class="tabulator"></div>

<script type="text/javascript" src="/node_modules/tabulator-tables/dist/js/tabulator.min.js"></script>
<script type="text/javascript" src="/node_modules/luxon/build/global/luxon.min.js"></script>
<script type="text/javascript" src="/node_modules/lodash/lodash.min.js"></script>
<script type="text/javascript" src="/js/wsm.tabulator.js"></script>
<script th:inline="javascript">
    let clientGrid;
    let currentRowId = 0;
    let editedRowIds = {
        created:  {}, // 신규
        modified: {}, // 수정
        deleted:  {}, // 삭제
    };
    const clientTypeCode = [
        {label: '일반', value: 'C01'},
        {label: 'EAP', value: 'C02'},
        {label: '기관/학교', value: 'C03'},
        {label: '임시고객', value: 'C04'},
    ];

    const searchBtn = document.getElementById("searchBtn");
    const addRowBtn = document.getElementById("addRowBtn");
    const saveBtn = document.getElementById("saveBtn");

    document.addEventListener("DOMContentLoaded", () => {
        initGrid();
    });

    searchBtn.addEventListener("click", () => getClientList());
    addRowBtn.addEventListener("click", () => addRow());
    saveBtn.addEventListener("click", () => saveData());

    /**
     * 그리드 초기화
     */
    const initGrid = () => {
        const columns = [
            {title: "gridRowId", field: "gridRowId", width: 50, visible: false},
            {title: "clientId", field: "clientId", width: 50, visible: false},
            {title: "status", field: "rowStatus", width: 50, visible: false},
            {title: "상태", field: "statusLabel", width: 50, headerSort: false, headerHozAlign: "center", hozAlign: "center"},
            {title: "삭제", field: "deleteChk", headerSort: false, headerHozAlign: "center", hozAlign: "center",
                formatter: function(cell) {
                    var value = cell.getValue();
                    return value
                        ? "<input type='checkbox' checked />"
                        : "<input type='checkbox' />";
                },
                cellClick: function(e, cell) {
                    var value = cell.getValue();
                    if(typeof value === "undefined") {
                        value = false;
                    }
                    cell.setValue(!value); // 체크박스 상태 토글
                },
                cellEdited: (cell) => deleteChkEditedFunc(cell),
            },
            {title: "고객번호", field: "clientNo", width: 120, editor: "input", headerHozAlign: "center", hozAlign: "center",
                cellEdited: (cell) => cellModifiedFunc(cell),
                editable: (cell) => editableFunc(cell),
                validator: [{
                    type: (cell, value, parameters) => validatorFunc(cell, value, parameters),
                    parameters: {
                        format: 'engNum',
                        errorMsg: '고객번호는 영문과 숫자만 입력 가능합니다.',
                    }
                }],
            },
            {title: "성명", field: "clientName", width: 120, editor: "input", headerHozAlign: "center", hozAlign: "center",
                cellEdited: (cell) => cellModifiedFunc(cell),
                editable: (cell) => editableFunc(cell),
            },
            {title: "고객구분", field: "clientTypeCode", width: 100, editor: "list", headerHozAlign: "center", hozAlign: "left",
                cellEdited: (cell) => cellModifiedFunc(cell),
                editable: (cell) => editableFunc(cell),
                editorParams: {
                    values: clientTypeCode,
                },
                formatter: (cell) => {
                    const value = cell.getValue();
                    const match = clientTypeCode.find(option => option.value === value);
                    return match ? match.label : value;
                },
            },
            {title: "휴대폰", field: "phoneNo", width: 130, editor: "input", headerHozAlign: "center", hozAlign: "center",
                cellEdited: (cell) => cellModifiedFunc(cell),
                editable: (cell) => editableFunc(cell),
                validator: [{
                    type: (cell, value, parameters) => validatorFunc(cell, value, parameters),
                    parameters: {
                        format: 'phone',
                        errorMsg: '올바른 전화번호 형식 (예: 010-1234-5678)이 아닙니다.',
                    }
                }],
            },
            {title: "이메일", field: "emailAddr", width: 180, editor: "input", headerHozAlign: "center", hozAlign: "left",
                cellEdited: (cell) => cellModifiedFunc(cell),
                editable: (cell) => editableFunc(cell),
                validator: [{
                    type: (cell, value, parameters) => validatorFunc(cell, value, parameters),
                    parameters: {
                        format: 'email',
                        errorMsg: '올바른 이메일 형식이 아닙니다.',
                    }
                }],
            },
            {title: "시작일", field: "beginYmd", width: 140, formatter: "datetime", editor: "date", headerHozAlign: "center", hozAlign: "center",
                formatterParams:{
                    inputFormat: "yyyyMMdd",
                    outputFormat: "yyyy-MM-dd",
                    invalidPlaceholder: "(invalid date)",
                },
                editorParams:{
                    min:"19000101",
                    max:"29991231",
                    format: "yyyyMMdd",
                    verticalNavigation: "table",
                },
                cellEdited: (cell) => cellModifiedFunc(cell),
                editable: (cell) => editableFunc(cell),
            },
            {title: "종료일", field:"endYmd", width: 140, formatter: "datetime", editor: "date", headerHozAlign: "center", hozAlign: "center",
                formatterParams:{
                    inputFormat: "yyyyMMdd",
                    outputFormat: "yyyy-MM-dd",
                    invalidPlaceholder: "(invalid date)",
                },
                editorParams:{
                    min:"19000101",
                    max:"29991231",
                    format: "yyyyMMdd",
                    verticalNavigation: "table",
                },
                cellEdited: (cell) => cellModifiedFunc(cell),
                editable: (cell) => editableFunc(cell),
            },
            {title: "비고", field: "note", width: 200, editor: "input", headerHozAlign: "center", hozAlign: "left",
                cellEdited: (cell) => cellModifiedFunc(cell),
                editable: (cell) => editableFunc(cell),
            },
        ];

        // 필수 표기
        columns.forEach((col) => {
            if (col.validator === 'required') {
                col.title += " <span style='color: red;'>*</span>";
            }
        });

        clientGrid = WsmTabulator.newTabulator("#client-grid", {
            height: '500px',
            layout: "fitDataStretch",
            columns: columns
        });

        clientGrid.on("dataLoaded", function(data){
            if(data && data.length > 0) {
                data.forEach(row => {
                    row.gridRowId = currentRowId++;
                    row.deleteChk = false;
                });
            }
        });

        // 유효성검사
        clientGrid.on("validationFailed", (cell, value, validators) => {
            alert(validators[0].parameters.errorMsg);
        });

        getClientList();
    }

    /**
     * Cell 수정 후처리
     */
    const cellModifiedFunc = (cell) => {
        let rowData = cell.getRow().getData();
        let gridRowId = rowData.gridRowId;

        // 추가 행은 수정으로 변경 하지 않음
        if(!_.isEmpty(editedRowIds.created[gridRowId])) return;

        let existing = editedRowIds.modified[gridRowId];
        cell.getRow().getCell("statusLabel").setValue("수정");
        if (!existing) {
            rowData.status = "M";
            editedRowIds.modified[gridRowId] = rowData;
        }
    }

    /**
     * Cell 삭제 후처리
     */
    const deleteChkEditedFunc = (cell) => {
        let rowData = cell.getRow().getData();
        let gridRowId = rowData.gridRowId;

        if(rowData.deleteChk) {
            // 추가 행을 삭제 체크하면 제거한다.
            if(!_.isEmpty(editedRowIds.created[gridRowId])) {
                delete editedRowIds.created[gridRowId];
                cell.getRow().delete();
                return;
            }

            // 삭제 체크 처리
            cell.getRow().getCell("statusLabel").setValue("삭제");
            rowData.status = "D";
            editedRowIds.deleted[gridRowId] = rowData;
        } else {
            // 삭제 취소 시 그전에 수정 상태 였다면 수정 상태로 맹글어 줌
            if(!_.isEmpty(editedRowIds.modified[gridRowId])) {
                rowData.status = "M";
                cell.getRow().getCell("statusLabel").setValue("수정");
            } else {
                rowData.status = "";
                cell.getRow().getCell("statusLabel").setValue("");
            }
            delete editedRowIds.deleted[gridRowId];
        }
    }

    /**
     * Cell 수정 가능여부
     */
    const editableFunc = (cell) => {
        let rowData = cell.getRow().getData();

        // 고객번호는 수정 불가
        if(cell.getColumn().getField() === "clientNo") {
            if(rowData.status === "C") return true;
            else return false;
        }

        return !(editedRowIds.deleted[rowData.gridRowId]);
    }

    /**
     * 고객목록 조회
     */
    const getClientList = () => {
        fetch("http://localhost:8080/api/client/list")
            .then(response => response.json())
            .then(response => {
                if(response.status === 200) {
                    editedRowIds.created  = {};
                    editedRowIds.modified = {};
                    editedRowIds.deleted  = {};
                    clientGrid.replaceData(response.data);
                }
            }
        );
    }

    /**
     * 행 추가
     */
    const addRow = () => {
        clientGrid.addRow({
            status: 'C',
            statusLabel: '추가',
            gridRowId: currentRowId++,
            beginYmd: '19000101',
            endYmd: '29991231',
        }).then(
            row => editedRowIds.created[row.getData().gridRowId] = row.getData()
        );
    }

    /**
     * 데이터 저장
     */
    const saveData = () => {
        let rows = clientGrid.getRows();

        let saveJson = [];
        rows.forEach(row => {
            const rowData = row.getData();
            if(["C","M","D"].indexOf(rowData.status) !== -1) {
                saveJson.push(rowData);
            }
        });

        if(saveJson.length < 1) {
            alert("저장할 데이터가 없습니다.");
            return;
        }

        if( confirm("저장 하시겠습니까?") ) {
            fetch("http://localhost:8080/api/client/save", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(saveJson),
            })
            .then(response => response.json())
            .then(response => {
                if( response.status === 200 ) {
                    alert("저장이 완료되었습니다.");
                    getClientList();
                } else {
                    alert("저장을 실패하였습니다.");
                }
            });
        }
    }

    /**
     * Cell 유효성검사
     */
    const validatorFunc = (cell, value, parameters) => {
        if(_.isEmpty(value)) {
            return true;
        }

        let format = parameters.format;
        if(!_.isEmpty(format)) {
            if(format === 'email') {
                return isValidEmail(value);
            }
            else if(format === 'phone') {
                return isValidPhoneNumber(value);
            }
            else if(format === 'engNum') {
                return isValidOnlyEngAndNumber(value);
            }
        }

        return true;
    }

    /**
     * 이메일 유효성 검사
     */
    const isValidEmail = (value) => {
        const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/; // 기본 이메일 패턴
        return regex.test(value);
    }

    /**
     * 전화번호 유효성 검사 (한국 기준: 숫자와 '-' 포함)
     */
    const isValidPhoneNumber = (value) => {
        const regex = /^\d{2,3}-\d{3,4}-\d{4}$/; // 형식: 010-1234-5678 또는 02-123-4567
        return regex.test(value);
    }

    /**
     * 영문&숫자 유효성 검사 (영문과 숫자만 사용 가능)
     */
    const isValidOnlyEngAndNumber = (value) => {
        const regex = /^[a-zA-Z0-9]+$/;
        return regex.test(value);
    }
</script>
</body>
</html>
