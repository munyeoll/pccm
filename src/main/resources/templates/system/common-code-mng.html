<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <link href="/node_modules/tabulator-tables/dist/css/tabulator_simple.min.css" rel="stylesheet">
    <link href="/css/tabulator-wsm.css" rel="stylesheet">
    <title>공통코드관리</title>
</head>
<body>
<h1>공통코드관리</h1>
<div class="buttons">
    <button id="searchBtn">조회</button>
    <button id="addRowBtn">추가</button>
    <button id="saveBtn">저장</button>
</div>
<!-- 고객목록 그리드 -->
<div id="code-master-grid" class="tabulator"></div>

<script type="text/javascript" src="/node_modules/tabulator-tables/dist/js/tabulator.min.js"></script>
<script type="text/javascript" src="/node_modules/luxon/build/global/luxon.min.js"></script>
<script type="text/javascript" src="/node_modules/lodash/lodash.min.js"></script>
<script type="text/javascript" src="/js/wsm.tabulator.js"></script>
<script th:inline="javascript">
    let codeMasterGrid;

    const searchBtn = document.getElementById("searchBtn");
    const addRowBtn = document.getElementById("addRowBtn");
    const saveBtn = document.getElementById("saveBtn");

    document.addEventListener("DOMContentLoaded", () => {
        initGrid();
    });

    searchBtn.addEventListener("click", () => getCodeMasterList());
    addRowBtn.addEventListener("click", () => addRow());
    saveBtn.addEventListener("click", () => saveData());

    /**
     * 그리드 초기화
     */
    const initGrid = () => {
        const columns = WsmTabulator.column
            .addText({title: "코드구분", field: "codeId", width: 120, align: 'left'})
            .addText({title: "코드구분명", field: "codeName", width: 150, align: 'left'})
            .addText({title: "비고", field: "note", width: 300, align: 'left'})
            .build()
        ;

        codeMasterGrid = WsmTabulator.newTabulator("#code-master-grid", {
            useStatus: true,
            useDelete: true,
            height: '500px',
            layout: "fitDataStretch",
            columns: columns,
            requiredFields: ["codeId", "codeName"],
        });

        getCodeMasterList();
    }

    /**
     * 고객목록 조회
     */
    const getCodeMasterList = () => {
        fetch("http://localhost:8080/api/code/master/list")
            .then(response => response.json())
            .then(response => {
                if(response.status === 200) {
                    codeMasterGrid.replaceData(response.data);
                }
            }
        );
    }

    /**
     * 행 추가
     */
    const addRow = () => {
        codeMasterGrid.addRow();
    }

    /**
     * 데이터 저장
     */
    const saveData = () => {
        let rows = codeMasterGrid.getRows();

        // 필수값 확인
        if(!codeMasterGrid.validateRequiredFields()) {
            return;
        }

        let saveJson = codeMasterGrid.getModifiedData();
        if(saveJson.length < 1) {
            alert("저장할 데이터가 없습니다.");
            return;
        }

        if( confirm("저장 하시겠습니까?") ) {
            fetch("http://localhost:8080/api/code/master/save", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(saveJson),
            })
            .then(response => response.json())
            .then(response => {
                if( response.status === 200 ) {
                    alert("저장이 완료되었습니다.");
                    getCodeMasterList();
                } else {
                    let errorMsg = response.message;
                    if(_.isEmpty(errorMsg)) {
                        errorMsg = "저장에 실패하였습니다.";
                    }
                    alert(errorMsg);
                }
            });
        }
    }
</script>
</body>
</html>